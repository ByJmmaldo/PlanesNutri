<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>MaldoFit Pro v6.0</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

<style>
    /* --- DISE√ëO GLASS DARK --- */
    :root { --bg: #000000; --surface: #121212; --text: #ffffff; --sub: #888; --accent: #b0fb5d; --bad: #ff4b4b; --warn: #ffb700; --ok: #b0fb5d; --border: #222; --radius: 16px; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    body { background:var(--bg); color:var(--text); margin:0; padding-bottom:120px; user-select:none; -webkit-font-smoothing: antialiased; overscroll-behavior-y: none; }
    
    /* HEADER */
    .header { padding: 15px 20px; position: sticky; top: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; justify-content: space-between; align-items: center; z-index: 50; border-bottom: 1px solid var(--border); padding-top: calc(env(safe-area-inset-top) + 15px); }
    h1 { margin:0; font-size:19px; font-weight:800; letter-spacing:-0.5px; background:linear-gradient(90deg,var(--accent),#bc13fe); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .icon-btn { background:none; border:none; color:var(--text); cursor:pointer; padding:8px; font-size: 22px; display: flex; align-items: center; justify-content: center; }
    
    /* EFECTO MAGIA */
    .magic-btn { animation: glow 2s infinite alternate; }
    @keyframes glow { from { text-shadow: 0 0 5px #fff, 0 0 10px var(--accent); } to { text-shadow: 0 0 10px #fff, 0 0 20px var(--accent); } }

    /* TABS */
    .tabs { display:flex; overflow-x:auto; gap:8px; padding:15px 20px; scrollbar-width:none; }
    .pill { background: var(--surface); padding: 8px 18px; border-radius: 100px; font-size: 13px; font-weight: 600; color: var(--sub); border: 1px solid transparent; white-space: nowrap; transition: 0.2s; }
    .pill.active { background: var(--text); color: #000; box-shadow: 0 4px 15px rgba(255,255,255,0.15); transform: scale(1.02); }
    
    /* DASHBOARD */
    .dash { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding:0 20px; margin-bottom:10px; }
    .stat { background:var(--surface); border-radius:var(--radius); padding:12px 5px; text-align:center; position:relative; overflow:hidden; border:1px solid #1a1a1a; }
    .val { display:block; font-weight:700; font-size:12px; margin-bottom:4px; z-index:2; position:relative; }
    .lbl { font-size:9px; color:var(--sub); font-weight:600; z-index:2; position:relative; }
    .stat-bar { position:absolute; bottom:0; left:0; height:3px; width:0%; transition: width 0.5s ease; opacity:0.8; }
    
    /* LISTA */
    .list { padding:20px; min-height:300px; padding-bottom:100px; }
    .item { background: var(--surface); border-radius: var(--radius); padding: 18px; margin-bottom: 12px; position: relative; animation: fadeIn 0.3s; border: 1px solid #1a1a1a; }
    .i-cat { font-size:9px; font-weight:800; color:var(--accent); text-transform:uppercase; margin-bottom:6px; letter-spacing:1px; opacity:0.8; }
    .i-name { font-size:16px; font-weight:600; margin-bottom:6px; padding-right:45px; line-height:1.3; }
    .i-det { font-size:12px; color:var(--sub); font-family: 'SF Mono', monospace; }
    .i-ing { font-size:13px; color:#aaa; margin-top:12px; padding-top:12px; border-top:1px solid #222; line-height:1.5; display:none; }
    .item.expanded .i-ing { display:block; animation:slideDown 0.2s; }
    
    /* BOTONES LISTA */
    .del { position:absolute; top:15px; right:15px; background:transparent; border:none; color:var(--sub); opacity:0.5; width:30px; height:30px; display:flex; align-items:center; justify-content:center; font-size:16px; }
    .add-btn { background:var(--ok); color:#000; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; position:absolute; top:12px; right:12px; font-weight:bold; font-size: 20px; z-index: 5; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
    .del-lib { background: #2a0000; color: #ff4b4b; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; top: 12px; right: 58px; font-size: 16px; border: 1px solid #ff4b4b; cursor: pointer; z-index: 5; }

    /* DOCK */
    .nav-container { position: fixed; bottom: 25px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 9999; pointer-events: none; padding-bottom: env(safe-area-inset-bottom); }
    .nav { background: rgba(20,20,20,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 12px 30px; border-radius: 100px; display: flex; gap: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 1px solid #333; pointer-events: auto; }
    .n-item { color:#555; background:none; border:none; transition:0.3s; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; padding: 0; }
    .n-item.active { filter: drop-shadow(0 0 5px var(--accent)); transform: scale(1.1); }

    /* MODALS & INPUTS */
    #modal, #lib, #archive-view, #creator { display:none; position:fixed; inset:0; background:var(--bg); z-index:200; overflow-y:auto; padding-top:calc(env(safe-area-inset-top) + 20px); animation: fadeIn 0.2s; }
    .m-box { padding:20px; max-width:500px; margin:0 auto; padding-bottom:80px; }
    .search-container { position:sticky; top:0; background:var(--bg); z-index:10; padding:20px; border-bottom:1px solid var(--border); display:flex; gap:10px; align-items: center; }
    .search { flex: 1; padding:14px 18px; background:var(--surface); border:1px solid #333; color:#fff; font-size:16px; border-radius:12px; outline:none; }
    .create-btn { background: var(--surface); border: 1px solid #333; color: var(--accent); width: 50px; height: 50px; border-radius: 12px; font-size: 28px; font-weight: 300; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
    .wk-inp { width:100%; padding:12px; background:var(--surface); border:1px solid #333; color:#fff; font-size:14px; border-radius:8px; outline:none; margin-bottom:10px; }
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; }
    .grid-wk { display:grid; gap:8px; margin-top:15px; }
    .wk-row { display:grid; grid-template-columns:40px 1fr 1fr 1fr 1fr; gap:6px; align-items:center; padding:5px; border-radius:8px; background:#0a0a0a; }
    .mini-inp { width:100%; background:transparent; border:none; color:#fff; text-align:center; font-size:13px; font-weight:600; outline:none; padding:8px 0; }
    .scan-btn { width:100%; margin-bottom:20px; padding:15px; background:linear-gradient(45deg, #222, #333); border:1px solid #444; border-radius:12px; color:var(--accent); font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; font-size:14px; }
    #scan-status { font-size:12px; color:var(--accent); text-align:center; margin-bottom:10px; display:none; }
    .arch-card { background:var(--surface); padding:15px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #222; }
    .arch-info h3 { margin:0; font-size:15px; } .arch-info p { margin:5px 0 0; color:var(--sub); font-size:12px; }

    @keyframes fadeIn { from{opacity:0;transform:scale(0.98)} to{opacity:1;transform:scale(1)} }
    @keyframes slideDown { from{opacity:0;height:0} to{opacity:1;height:auto} }
    @keyframes pulse { 0%{opacity:0.5} 100%{opacity:1} }
</style>
</head>
<body>

<div id="app">
    <div class="header">
        <h1>MaldoFit</h1>
        <div style="display:flex; gap:15px;">
            <button class="icon-btn magic-btn" onclick="autoGeneratePlan()" title="Autocompletar D√≠a">ü™Ñ</button>
            <button class="icon-btn" onclick="saveToArchive()">üíæ</button>
            <button class="icon-btn" onclick="openModal()">‚öôÔ∏è</button>
        </div>
    </div>
    <div class="tabs" id="days"></div>
    <div class="dash">
        <div class="stat"><span class="val" id="dk">0</span><span class="lbl">KCAL</span><div class="stat-bar" id="bk" style="background:#fff"></div></div>
        <div class="stat"><span class="val" id="dp">0</span><span class="lbl">PROT</span><div class="stat-bar" id="bp" style="background:var(--bad)"></div></div>
        <div class="stat"><span class="val" id="dc">0</span><span class="lbl">CARB</span><div class="stat-bar" id="bc" style="background:var(--warn)"></div></div>
        <div class="stat"><span class="val" id="df">0</span><span class="lbl">GRAS</span><div class="stat-bar" id="bf" style="background:var(--ok)"></div></div>
    </div>
    <div id="loading" style="text-align:center; padding:40px; color:var(--sub);">
        <div style="font-size:30px;margin-bottom:10px;animation:fadeIn 1s infinite alternate">‚òÅÔ∏è</div>
    </div>
    <div id="list" class="list"></div>
</div>

<div id="lib">
    <div class="search-container">
        <button onclick="document.getElementById('lib').style.display='none'" class="icon-btn" style="font-size:24px">‚úï</button>
        <input type="text" id="search" class="search" placeholder="Buscar..." onkeyup="renderLib()">
        <button class="create-btn" onclick="openCreator()">+</button>
    </div>
    <div class="tabs" id="cats" style="padding:0 20px 10px;"></div>
    <div id="lib-list" class="list" style="padding-top:0"></div>
</div>

<div id="creator">
    <div class="m-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="color:var(--accent); margin:0;">Nuevo Alimento</h2>
            <button onclick="document.getElementById('creator').style.display='none'" class="icon-btn">‚úï</button>
        </div>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="processImage(this)">
        <button class="scan-btn" onclick="document.getElementById('cameraInput').click()">
            <span style="font-size:18px">üì∑</span> ESCANEAR ETIQUETA (IA)
        </button>
        <div id="scan-status">‚è≥ Analizando...</div>
        <label style="color:#fff; font-size:12px; font-weight:bold;">NOMBRE</label>
        <input type="text" id="new-name" class="wk-inp" placeholder="Ej: Pan con Jam√≥n">
        <div class="form-grid" style="margin-top:15px;">
            <div><label style="color:var(--bad); font-size:12px; font-weight:bold;">PROTE√çNA</label><input type="number" id="new-p" class="wk-inp" placeholder="0" oninput="autoCalcKcal()"></div>
            <div><label style="color:var(--warn); font-size:12px; font-weight:bold;">CARBOS</label><input type="number" id="new-c" class="wk-inp" placeholder="0" oninput="autoCalcKcal()"></div>
        </div>
        <div class="form-grid">
            <div><label style="color:var(--ok); font-size:12px; font-weight:bold;">GRASAS</label><input type="number" id="new-f" class="wk-inp" placeholder="0" oninput="autoCalcKcal()"></div>
            <div><label style="color:#fff; font-size:12px; font-weight:bold;">KCAL (Auto)</label><input type="number" id="new-k" class="wk-inp" placeholder="0" readonly style="background:#111; color:#888;"></div>
        </div>
        <label style="color:#fff; font-size:12px; font-weight:bold;">INGREDIENTES (Opcional)</label>
        <input type="text" id="new-ing" class="wk-inp" placeholder="Ej: 50g pan...">
        <button onclick="saveCustomFood()" style="width:100%; padding:15px; background:var(--accent); color:#000; border:none; border-radius:12px; font-weight:bold; margin-top:10px;">GUARDAR EN NUBE</button>
    </div>
</div>

<div id="archive-view"><div class="header"><h1>Mis Dietas</h1><button onclick="document.getElementById('archive-view').style.display='none'" class="icon-btn">‚úï</button></div><div class="list" id="archive-list"></div></div>

<div id="modal">
    <div class="m-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><h2 style="color:#fff;margin:0;">Ajustes</h2><button onclick="document.getElementById('modal').style.display='none'" class="icon-btn">‚úï</button></div>
        <div style="background:var(--surface); padding:20px; border-radius:16px; margin-bottom:20px; border:1px solid #222;">
            <h3 style="margin:0 0 10px 0; color:var(--accent); font-size:11px;">CALCULADORA MIFFLIN-ST. JEOR</h3>
            <div class="form-grid">
                <select id="sex" class="wk-inp"><option value="m">Hombre</option><option value="f">Mujer</option></select>
                <input type="number" id="age" class="wk-inp" value="30" placeholder="Edad">
                <input type="number" id="w" class="wk-inp" value="80" placeholder="Kg">
                <input type="number" id="h" class="wk-inp" value="180" placeholder="Cm">
            </div>
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-bottom:10px;">
                <select id="act" class="wk-inp"><option value="1.2">Sedentario</option><option value="1.375">Ligero</option><option value="1.55" selected>Moderado</option><option value="1.725">Intenso</option></select>
                <select id="target-day" class="wk-inp" style="background:#222; border-color:#444; color:var(--accent); font-weight:bold;"><option value="all">Todo</option><option value="Lunes">Lun</option><option value="Martes">Mar</option><option value="Mi√©rcoles">Mi√©</option><option value="Jueves">Jue</option><option value="Viernes">Vie</option><option value="S√°bado">S√°b</option><option value="Domingo">Dom</option></select>
            </div>
            <select id="goal" class="wk-inp" style="border-color:var(--accent);"><option value="-0.25">Definici√≥n Agresiva (-25%)</option><option value="-0.15">Definici√≥n Lenta (-15%)</option><option value="0">Mantenimiento</option><option value="0.15">Volumen Limpio (+15%)</option><option value="0.20">Volumen Agresivo (+20%)</option></select>
            <button onclick="calcAuto()" style="width:100%; padding:12px; background:var(--text); color:#000; border:none; border-radius:10px; font-weight:bold;">CALCULAR</button>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center;"><h3 style="margin:0; font-size:14px; color:#fff;">Ajuste Manual</h3><div style="background:#222; border-radius:20px; padding:3px;"><button id="mode-g" class="icon-btn" style="border-radius:15px; font-size:10px; padding:5px 12px;" onclick="setMode('g')">G</button><button id="mode-p" class="icon-btn" style="border-radius:15px; font-size:10px; padding:5px 12px;" onclick="setMode('p')">%</button></div></div>
        <div id="grid-wk" class="grid-wk"></div>
        <button onclick="saveConfig()" style="width:100%; padding:15px; background:var(--accent); color:#000; border:none; border-radius:12px; font-weight:bold; margin-top:20px;">GUARDAR</button>
    </div>
</div>

<div class="nav-container"><div class="nav"><button class="n-item active" onclick="switchView('app')">üìã</button><button class="n-item" onclick="document.getElementById('lib').style.display='block'">‚ûï</button><button class="n-item" onclick="openArchive()">üìÇ</button></div></div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDTPiVRMpYkP3HZXcoGpWmPvcmReKE_Jv4",
      authDomain: "nutriapp-ec26e.firebaseapp.com",
      projectId: "nutriapp-ec26e",
      storageBucket: "nutriapp-ec26e.firebasestorage.app",
      messagingSenderId: "464297642527",
      appId: "1:464297642527:web:77d7ecaef0229f9f9fe32a"
    };

    let db, foodDB = [], state = { day:'Lunes', cat:'Desayuno', plan:{}, targets:{}, mode: 'g' };
    const DAYS = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
    const CATS = ["Desayuno","Tentempi√©","Comida","Merienda","Cena"];

    function init() {
        try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); loadData(); } catch(e) { console.error(e); }
        DAYS.forEach(d=>{ if(!state.plan[d]) state.plan[d]=[]; });
        const t = localStorage.getItem('mf_targets_v6'), p = localStorage.getItem('mf_plan');
        if(t) state.targets = JSON.parse(t); else calcAuto(true);
        if(p) state.plan = JSON.parse(p);
        renderDays(); renderCats(); renderPlan();
        if(state.targets) renderGrid();
        setMode('g');
    }

    async function loadData() {
        const snap = await db.collection("comidas").get();
        if(snap.empty) return;
        foodDB = [];
        snap.forEach(doc => foodDB.push(doc.data()));
        document.getElementById('loading').style.display='none';
        renderLib();
    }

    // --- AUTO GENERADOR (M√âTODO MONTECARLO) ---
    window.autoGeneratePlan = function() {
        const target = state.targets[state.day];
        if(!target || target.k < 500) { alert("Configura primero tus objetivos"); return; }
        
        if(!confirm(`¬øGenerar plan autom√°tico para el ${state.day}?\nObjetivo: ${target.k} Kcal (Prioridad Prote√≠nas)`)) return;

        // 1. Clasificar platos
        const breakfasts = foodDB.filter(x => x.type === "Desayuno");
        const snacks = foodDB.filter(x => x.type === "Tentempi√©" || x.type === "Merienda");
        const meals = foodDB.filter(x => x.type === "Comida" || x.type === "Cena");

        if(breakfasts.length < 1 || meals.length < 2) { alert("Faltan platos en la base de datos"); return; }

        let bestPlan = [];
        let bestScore = Infinity;

        // 2. Simulaci√≥n Montecarlo (1000 intentos)
        for(let i=0; i<1000; i++) {
            const plan = [];
            // Estructura: Desayuno, Tentempi√©, Comida, Merienda, Cena
            plan.push(getRandom(breakfasts));
            plan.push(getRandom(snacks));
            plan.push(getRandom(meals));
            plan.push(getRandom(snacks));
            plan.push(getRandom(meals));

            // Calcular Sumas
            let k=0, p=0, c=0, f=0;
            plan.forEach(x => { k+=x.kcal; p+=x.p; c+=x.c; f+=x.f; });

            // Calcular Error (Puntaje)
            // Priorizamos Prote√≠na (x3) y Calor√≠as (x1)
            const score = (Math.abs(target.k - k)) + (Math.abs(target.p - p) * 3);

            if(score < bestScore) {
                bestScore = score;
                bestPlan = plan;
            }
        }

        // 3. Aplicar Ganador
        state.plan[state.day] = bestPlan;
        renderPlan();
        
        let totalK = bestPlan.reduce((a,b)=>a+b.kcal,0);
        alert(`‚ú® ¬°Magia realizada!\nPlan generado: ${totalK} Kcal\n(Diferencia: ${totalK - target.k} kcal)`);
    }

    function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    // --- BORRADO NUBE ---
    window.deleteFromCloud = async (id, e) => {
        e.stopPropagation(); if(!confirm("‚ö†Ô∏è ¬øBorrar de BD?")) return;
        let docId = (id > 1000000000) ? "c_" + id : "p" + id;
        try { await db.collection("comidas").doc(docId).delete(); foodDB = foodDB.filter(x => x.id !== id); renderLib(); alert("üóëÔ∏è Eliminado"); } catch(e) { alert("Error: " + e.message); }
    }

    // --- IA & CREACI√ìN ---
    window.openCreator = () => { document.getElementById('creator').style.display='block'; }
    window.autoCalcKcal = () => {
        const p = parseFloat(document.getElementById('new-p').value)||0, c = parseFloat(document.getElementById('new-c').value)||0, f = parseFloat(document.getElementById('new-f').value)||0;
        document.getElementById('new-k').value = Math.round((p*4) + (c*4) + (f*9));
    }
    window.processImage = async (input) => {
        const file = input.files[0]; if(!file) return;
        const status = document.getElementById('scan-status'); status.style.display = "block"; status.style.animation = "pulse 1s infinite";
        try {
            const worker = await Tesseract.createWorker('eng'); const ret = await worker.recognize(file); const text = ret.data.text.toLowerCase();
            const find = (keys) => { const regex = new RegExp(`(${keys.join('|')})[^0-9]*([0-9]+[.,]?[0-9]*)`, 'i'); const match = text.match(regex); return match ? parseFloat(match[2].replace(',','.')) : 0; };
            const p = find(['protein','proteina']), c = find(['carb','hidratos']), f = find(['fat','grasa']), k = find(['kcal','energy','valor']);
            if(p) document.getElementById('new-p').value = p; if(c) document.getElementById('new-c').value = c; if(f) document.getElementById('new-f').value = f;
            setTimeout(() => { if(k > 0 && k < (p*4+c*4+f*9)*2) document.getElementById('new-k').value = k; else autoCalcKcal(); }, 100);
            status.innerHTML = "‚úÖ ¬°Le√≠do!"; status.style.animation = "none"; await worker.terminate();
        } catch (e) { status.innerHTML = "‚ùå Error lectura."; }
    }
    window.saveCustomFood = async () => {
        const name = document.getElementById('new-name').value, p = parseFloat(document.getElementById('new-p').value)||0, c = parseFloat(document.getElementById('new-c').value)||0, f = parseFloat(document.getElementById('new-f').value)||0, k = parseInt(document.getElementById('new-k').value)||0, ing = document.getElementById('new-ing').value || "Personalizado";
        if(!name) { alert("Pon un nombre"); return; }
        const newItem = { id: Date.now(), name: name, type: state.cat, p: p, c: c, f: f, kcal: k, ings: ing };
        try { await db.collection("comidas").doc("c_" + newItem.id).set(newItem); foodDB.push(newItem); renderLib(); document.getElementById('creator').style.display='none'; document.getElementById('new-name').value = ""; alert("‚úÖ Guardado"); } catch(e) { alert("Error: " + e.message); }
    }

    // --- CORE ---
    window.saveToArchive = function() {
        const name = prompt("Nombre:"); if(!name) return;
        const item = { id: Date.now(), name: name, date: new Date().toLocaleDateString(), plan: state.plan, targets: state.targets };
        let archive = JSON.parse(localStorage.getItem('mf_archive') || "[]");
        archive.push(item); localStorage.setItem('mf_archive', JSON.stringify(archive)); alert("Guardado");
    }
    window.openArchive = () => {
        document.getElementById('archive-view').style.display = 'block';
        const l = document.getElementById('archive-list'), archive = JSON.parse(localStorage.getItem('mf_archive') || "[]");
        l.innerHTML = archive.length ? '' : '<div style="text-align:center;padding:40px;color:#666">Vac√≠o</div>';
        archive.reverse().forEach((item, idx) => {
            l.innerHTML += `<div class="arch-card"><div class="arch-info"><h3>${item.name}</h3><p>${item.date}</p></div><div class="arch-actions"><button class="icon-btn" style="color:var(--accent)" onclick="loadFromArchive(${item.id})">üì•</button><button class="icon-btn" style="color:var(--bad)" onclick="deleteArchive(${idx})">‚úï</button></div></div>`;
        });
    }
    window.loadFromArchive = (id) => { if(!confirm("¬øCargar?")) return; const item = JSON.parse(localStorage.getItem('mf_archive')).find(x => x.id === id); if(item) { state.plan = item.plan; state.targets = item.targets; renderPlan(); renderGrid(); switchView(); } }
    window.deleteArchive = (idx) => { if(!confirm("¬øBorrar?")) return; let a = JSON.parse(localStorage.getItem('mf_archive')); a.splice(a.length - 1 - idx, 1); localStorage.setItem('mf_archive', JSON.stringify(a)); openArchive(); }
    window.switchView = () => { document.getElementById('archive-view').style.display='none'; document.getElementById('lib').style.display='none'; }

    window.calcAuto = (silent) => {
        const w=parseFloat(document.getElementById('w').value)||80, h=parseFloat(document.getElementById('h').value)||180, a=parseFloat(document.getElementById('age').value)||30, s=document.getElementById('sex').value, act=parseFloat(document.getElementById('act').value)||1.55, goal=parseFloat(document.getElementById('goal').value)||0, targetDay=document.getElementById('target-day').value;
        let tmb = (s==='m') ? (10*w)+(6.25*h)-(5*a)+5 : (10*w)+(6.25*h)-(5*a)-161;
        const kFinal = Math.round(tmb*act*(1+goal)), p=Math.round(w*2), f=Math.round(w*0.9), c=Math.round((kFinal-(p*4)-(f*9))/4);
        if (targetDay === 'all') DAYS.forEach(d => state.targets[d] = {k: kFinal, p, c, f}); else state.targets[targetDay] = {k: kFinal, p, c, f};
        if(!silent) { renderGrid(); alert(`‚úÖ Calculado (${targetDay}): ${kFinal} kcal`); }
    }

    window.setMode = (m) => { state.mode = m; renderGrid(); }
    function renderGrid() {
        const g = document.getElementById('grid-wk'); g.innerHTML = '';
        DAYS.forEach(d => {
            const t = state.targets[d] || {k:2500,p:160,c:300,f:70};
            let valP=t.p, valC=t.c, valF=t.f;
            if(state.mode==='p') { const k=t.k||1; valP=Math.round((t.p*4/k)*100); valC=Math.round((t.c*4/k)*100); valF=Math.round((t.f*9/k)*100); }
            g.innerHTML += `<div class="wk-row"><span style="font-size:10px;font-weight:700;color:#888">${d.substr(0,3)}</span><input id="k_${d}" value="${t.k}" class="mini-inp" onchange="updRow('${d}')"><input id="p_${d}" value="${valP}" class="mini-inp" style="color:var(--bad)" onchange="updRow('${d}')"><input id="c_${d}" value="${valC}" class="mini-inp" style="color:var(--warn)" onchange="updRow('${d}')"><input id="f_${d}" value="${valF}" class="mini-inp" style="color:var(--ok)" onchange="updRow('${d}')"></div>`;
        });
    }
    window.updRow = (d) => {
        const k = parseInt(document.getElementById(`k_${d}`).value)||0;
        let p=parseInt(document.getElementById(`p_${d}`).value)||0, c=parseInt(document.getElementById(`c_${d}`).value)||0, f=parseInt(document.getElementById(`f_${d}`).value)||0;
        if(state.mode==='p') state.targets[d] = { k, p:Math.round((k*p/100)/4), c:Math.round((k*c/100)/4), f:Math.round((k*f/100)/9) }; else state.targets[d] = { k, p, c, f };
    }
    window.saveConfig = () => { DAYS.forEach(d=>updRow(d)); localStorage.setItem('mf_targets_v6', JSON.stringify(state.targets)); document.getElementById('modal').style.display='none'; renderPlan(); }

    function renderDays() { document.getElementById('days').innerHTML = DAYS.map(d => `<div class="pill ${state.day===d?'active':''}" onclick="setDay('${d}')">${d}</div>`).join(''); }
    function renderCats() { document.getElementById('cats').innerHTML = CATS.map(c => `<div class="pill ${state.cat===c?'active':''}" onclick="setCat('${c}')">${c}</div>`).join(''); }
    window.setDay = d => { state.day=d; renderDays(); renderPlan(); }
    window.setCat = c => { state.cat=c; renderCats(); renderLib(); }
    window.openModal = () => { document.getElementById('modal').style.display='block'; renderGrid(); }

    window.renderLib = () => {
        const l = document.getElementById('lib-list'), s = document.getElementById('search').value.toLowerCase(); l.innerHTML='';
        foodDB.filter(x => {
            let m = x.type === state.cat; if(state.cat==='Tentempi√©' && (x.type.includes('Ma√±ana')||x.type.includes('M.MA√ëANA'))) m=true;
            return m && (x.name.toLowerCase().includes(s) || x.ings.toLowerCase().includes(s));
        }).forEach(x => {
            l.innerHTML += `<div class="item" onclick="this.classList.toggle('expanded')">
            <div class="i-name">${x.name}</div>
            <div class="i-det">üî•${x.kcal} <span style="color:var(--bad)">P${x.p}</span> <span style="color:var(--warn)">C${x.c}</span> <span style="color:var(--ok)">F${x.f}</span></div>
            <div class="i-ing">${x.ings}</div>
            <button class="add-btn" onclick="add(${x.id}, event)">+</button>
            <button class="del-lib" onclick="deleteFromCloud(${x.id}, event)">üóëÔ∏è</button>
            </div>`;
        });
    }

    window.renderPlan = () => {
        const l = document.getElementById('list'); l.innerHTML = ''; let t = {k:0,p:0,c:0,f:0};
        const cp = state.plan[state.day]||[]; if(cp.length===0) l.innerHTML = '<div style="text-align:center;padding:50px;color:#333;font-style:italic">D√≠a vac√≠o</div>';
        cp.forEach((x,i)=>{
            t.k+=x.kcal; t.p+=x.p; t.c+=x.c; t.f+=x.f;
            l.innerHTML += `<div class="item" onclick="this.classList.toggle('expanded')"><div class="i-cat">${x.type}</div><div class="i-name">${x.name}</div><div class="i-det">üî•${x.kcal} P${x.p} C${x.c} F${x.f}</div><div class="i-ing">${x.ings}</div><button class="del" onclick="del(${i})">‚úï</button></div>`;
        });
        const tgt = state.targets[state.day] || {k:2500,p:160,c:300,f:70}; upd('k',t.k,tgt.k); upd('p',t.p,tgt.p); upd('c',t.c,tgt.c); upd('f',t.f,tgt.f);
        localStorage.setItem('mf_plan', JSON.stringify(state.plan));
    }

    function upd(k,v,m) { document.getElementById('d'+k).innerText = v + " / " + m; document.getElementById('b'+k).style.width = Math.min((v/m)*100,100)+'%'; }
    window.add = (id, e) => { e.stopPropagation(); const item = foodDB.find(x => x.id === id); state.plan[state.day].push(item); renderPlan(); document.getElementById('lib').style.display='none'; }
    window.del = i => { if(confirm("¬øQuitar del d√≠a?")) { state.plan[state.day].splice(i,1); renderPlan(); } }

    init();
</script>
</body>
</html>
