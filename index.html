<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MaldoFit NEON</title>
    <style>
        :root {
            /* PALETA DARK NEON */
            --bg-body: #121212;
            --bg-card: #1E1E1E;
            --bg-nav: rgba(30, 30, 30, 0.95);
            
            --primary: #00f2ff; /* Cyan Neon */
            --accent: #bc13fe;  /* Purple Neon */
            --success: #0aff60; /* Green Neon */
            --warning: #ffd500; /* Yellow Neon */
            --danger: #ff2a6d;  /* Pink Neon */
            
            --text-main: #ffffff;
            --text-sec: #a0a0a0;
            --border: #333333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            padding-bottom: 100px; padding-top: env(safe-area-inset-top);
            height: 100vh; overflow-y: scroll;
        }

        /* --- HEADER & TABS --- */
        .header {
            padding: 20px; background: var(--bg-body);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 10;
        }
        h1 { margin: 0; font-size: 26px; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .day-scroll {
            display: flex; overflow-x: auto; padding: 0 20px 15px 20px; gap: 10px;
            scrollbar-width: none;
        }
        .day-pill {
            background: var(--bg-card); border: 1px solid var(--border);
            padding: 10px 18px; border-radius: 20px; color: var(--text-sec);
            font-weight: 600; font-size: 14px; white-space: nowrap; transition: 0.2s;
        }
        .day-pill.active {
            background: var(--primary); color: #000; border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
        }

        /* --- MACRO DASHBOARD --- */
        .macro-dash {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            padding: 0 20px 20px 20px;
        }
        .macro-box {
            background: var(--bg-card); padding: 12px 5px; border-radius: 12px;
            text-align: center; border: 1px solid var(--border);
        }
        .m-val { font-size: 14px; font-weight: 700; display: block; color: white; }
        .m-lbl { font-size: 10px; color: var(--text-sec); text-transform: uppercase; margin-top: 2px; }
        .progress-track { height: 4px; background: #333; margin-top: 8px; border-radius: 2px; overflow: hidden; margin: 8px 5px 0 5px; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.5s; }

        /* --- COMIDAS --- */
        .meal-list { padding: 0 20px; }
        .meal-item {
            background: var(--bg-card); border-radius: 16px; padding: 16px;
            margin-bottom: 15px; border: 1px solid var(--border); position: relative;
        }
        .meal-type { font-size: 11px; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .meal-name { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #fff; }
        .meal-info { font-size: 13px; color: var(--text-sec); margin-bottom: 5px; }
        .ing-text { font-size: 12px; color: #666; font-style: italic; line-height: 1.4; }
        
        .btn-del {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; color: var(--danger); font-size: 18px;
        }

        /* --- BIBLIOTECA --- */
        .cat-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 10px 20px; scrollbar-width: none; }
        .cat-chip {
            padding: 8px 16px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 20px; color: var(--text-sec); font-size: 13px; font-weight: 600; white-space: nowrap;
        }
        .cat-chip.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .search-box {
            width: 100%; padding: 14px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; color: white; font-size: 16px; outline: none; margin-bottom: 10px;
        }
        .search-wrapper { padding: 0 20px; position: sticky; top: 0; background: var(--bg-body); z-index: 5; padding-bottom: 10px; }

        .add-btn {
            background: var(--success); color: #000; width: 32px; height: 32px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 18px; position: absolute; right: 15px; top: 35%;
            box-shadow: 0 0 10px rgba(10, 255, 96, 0.4);
        }

        /* --- MODAL CALCULADORA --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-card {
            background: var(--bg-card); border: 1px solid var(--border);
            width: 90%; max-width: 450px; padding: 25px; border-radius: 20px;
            max-height: 90vh; overflow-y: auto;
        }
        .form-label { display: block; color: var(--text-sec); font-size: 12px; margin-bottom: 5px; text-transform: uppercase; font-weight: 700; }
        .form-input, .form-select {
            width: 100%; background: #121212; border: 1px solid var(--border);
            color: white; padding: 12px; border-radius: 8px; font-size: 16px; margin-bottom: 15px;
        }
        .btn-neon {
            width: 100%; padding: 14px; border-radius: 10px; border: none;
            background: var(--primary); color: #000; font-weight: 800; font-size: 16px;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.3); margin-top: 10px;
        }
        
        .cycle-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        .cycle-table th { text-align: left; color: var(--primary); padding: 5px; border-bottom: 1px solid var(--border); }
        .cycle-table td { padding: 8px 5px; border-bottom: 1px solid #333; color: var(--text-sec); }

        /* --- NAVBAR --- */
        .navbar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-nav); backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; padding: 12px 0 25px 0;
            z-index: 100;
        }
        .nav-btn { background: none; border: none; color: var(--text-sec); font-size: 10px; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-btn.active { color: var(--primary); }
        .nav-icon { font-size: 20px; }

        /* --- UTILS --- */
        .view { display: none; padding-bottom: 100px; }
        .view.active { display: block; }
        
        @media print {
            body { background: white; color: black; }
            .navbar, .header, .day-scroll, .search-wrapper, .cat-scroll { display: none !important; }
            .view { display: block !important; }
            .meal-item { border: 1px solid #ccc; background: white; color: black; break-inside: avoid; }
            .meal-name { color: black; }
            .meal-info { color: #555; }
        }
    </style>
</head>
<body>

    <div id="view-planner" class="view active">
        <div class="header">
            <h1>MaldoFit <span style="color:var(--primary)">.Pro</span></h1>
            <button onclick="document.getElementById('modal-config').style.display='flex'" style="background:transparent; border:1px solid var(--primary); color:var(--primary); padding:5px 15px; border-radius:15px;">OBJETIVOS</button>
        </div>

        <div class="day-scroll">
            <div class="day-pill active" onclick="setDay('Lunes', this)">Lunes</div>
            <div class="day-pill" onclick="setDay('Martes', this)">Martes</div>
            <div class="day-pill" onclick="setDay('Mi√©rcoles', this)">Mi√©rcoles</div>
            <div class="day-pill" onclick="setDay('Jueves', this)">Jueves</div>
            <div class="day-pill" onclick="setDay('Viernes', this)">Viernes</div>
            <div class="day-pill" onclick="setDay('S√°bado', this)">S√°bado</div>
            <div class="day-pill" onclick="setDay('Domingo', this)">Domingo</div>
        </div>

        <div class="macro-dash">
            <div class="macro-box">
                <span class="m-val" id="val-k">0</span>
                <span class="m-lbl">Kcal</span>
                <div class="progress-track"><div id="bar-k" class="progress-fill" style="background:#fff"></div></div>
            </div>
            <div class="macro-box">
                <span class="m-val" id="val-p">0</span>
                <span class="m-lbl">Prot</span>
                <div class="progress-track"><div id="bar-p" class="progress-fill" style="background:var(--danger)"></div></div>
            </div>
            <div class="macro-box">
                <span class="m-val" id="val-c">0</span>
                <span class="m-lbl">Carb</span>
                <div class="progress-track"><div id="bar-c" class="progress-fill" style="background:var(--warning)"></div></div>
            </div>
            <div class="macro-box">
                <span class="m-val" id="val-f">0</span>
                <span class="m-lbl">Grasa</span>
                <div class="progress-track"><div id="bar-f" class="progress-fill" style="background:var(--success)"></div></div>
            </div>
        </div>

        <div id="planner-list" class="meal-list">
            </div>
    </div>

    <div id="view-library" class="view">
        <div class="header">
            <h1>Alimentos</h1>
        </div>
        <div class="search-wrapper">
            <input type="text" id="search" class="search-box" placeholder="Buscar plato..." onkeyup="renderLib()">
        </div>
        <div class="cat-scroll">
            <div class="cat-chip active" onclick="filterCat('Desayuno', this)">Desayuno</div>
            <div class="cat-chip" onclick="filterCat('Tentempi√©', this)">Media Ma√±ana</div>
            <div class="cat-chip" onclick="filterCat('Comida', this)">Comida</div>
            <div class="cat-chip" onclick="filterCat('Merienda', this)">Merienda</div>
            <div class="cat-chip" onclick="filterCat('Cena', this)">Cena</div>
        </div>
        <div id="lib-list" class="meal-list" style="margin-top:20px;"></div>
    </div>

    <div id="modal-config" class="modal-overlay">
        <div class="modal-card">
            <h2 style="color:var(--primary); margin-top:0">Calculadora Objetivos</h2>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div><label class="form-label">Peso (kg)</label><input type="number" id="w" class="form-input" value="80"></div>
                <div><label class="form-label">Altura (cm)</label><input type="number" id="h" class="form-input" value="180"></div>
                <div><label class="form-label">Edad</label><input type="number" id="a" class="form-input" value="30"></div>
                <div><label class="form-label">Sexo</label>
                    <select id="s" class="form-select">
                        <option value="m">Hombre</option>
                        <option value="f">Mujer</option>
                    </select>
                </div>
            </div>

            <label class="form-label">Nivel de Actividad</label>
            <select id="act" class="form-select">
                <option value="1.2">Sedentario (Oficina, sin entreno)</option>
                <option value="1.375">Ligero (1-3 d√≠as)</option>
                <option value="1.55" selected>Moderado (CrossFit 3-5 d√≠as)</option>
                <option value="1.725">Alto (6-7 d√≠as)</option>
                <option value="1.9">Atleta Profesional (Doble sesi√≥n)</option>
            </select>

            <label class="form-label">Objetivo Actual</label>
            <select id="goal" class="form-select" style="border-color:var(--accent)">
                <option value="-0.25">Definici√≥n Agresiva (-25%)</option>
                <option value="-0.15">Definici√≥n Moderada (-15%)</option>
                <option value="0">Mantenimiento</option>
                <option value="0.10">Volumen Limpio (+10%)</option>
                <option value="0.20">Volumen Agresivo (+20%)</option>
            </select>

            <button class="btn-neon" onclick="calculateMacros()">Calcular y Guardar</button>

            <div style="margin-top:20px;">
                <h4 style="margin:0; color:#fff;">Tu Ciclo Semanal:</h4>
                <table class="cycle-table">
                    <thead><tr><th>D√≠a</th><th>Kcal</th><th>Prot</th><th>Carb</th><th>Grasa</th></tr></thead>
                    <tbody id="cycle-body"></tbody>
                </table>
            </div>
            
            <button onclick="document.getElementById('modal-config').style.display='none'" style="width:100%; padding:15px; background:none; border:none; color:#666; margin-top:10px;">Cerrar</button>
        </div>
    </div>

    <nav class="navbar">
        <button class="nav-btn active" onclick="switchView('view-planner', this)">
            <span class="nav-icon">üìÖ</span> Plan
        </button>
        <button class="nav-btn" onclick="switchView('view-library', this)">
            <span class="nav-icon">üçî</span> Alimentos
        </button>
        <button class="nav-btn" onclick="window.print()">
            <span class="nav-icon">üñ®Ô∏è</span> PDF
        </button>
    </nav>

    <script>
        // --- BASE DE DATOS MAESTRA ---
        // Incluye los platos de Nov/Dic recuperados manualmente
        const foodDB = [
            // DESAYUNOS NOVIEMBRE / DICIEMBRE
            {id:1001,type:"Desayuno",name:"Tortilla de 4 Huevos y Jam√≥n",kcal:450,p:35,c:5,f:30,ings:"Huevos (4), Jam√≥n cocido (40g), Queso fundir (30g), Pan blanco (2 rebanadas)"},
            {id:1002,type:"Desayuno",name:"Queso Ricotta con Mango y Pistacho",kcal:380,p:25,c:30,f:18,ings:"Queso Ricotta (150g), Mango (100g), Prote√≠na en polvo (15g), Pistachos (30g)"},
            {id:1003,type:"Desayuno",name:"Pan Blanco con Jam√≥n y Queso",kcal:320,p:15,c:40,f:10,ings:"Pan blanco (2 rebanadas), Jam√≥n cocido (40g), Queso (30g)"},
            
            // MEDIA MA√ëANA / MERIENDA NOVIEMBRE / DICIEMBRE
            {id:1004,type:"Tentempi√©",name:"Papilla de Arroz con Prote√≠na y Miel",kcal:380,p:30,c:60,f:2,ings:"Harina de arroz (70g), Prote√≠na en polvo (30g), Miel (20g), Ar√°ndanos (60g)"},
            {id:1005,type:"Merienda",name:"Pur√© de Verduras y Boquerones",kcal:350,p:25,c:30,f:15,ings:"Pur√© verduras, Pan (80g), Boquerones en vinagre (60g), Queso fresco (200g)"},
            
            // COMIDAS / CENAS NOVIEMBRE / DICIEMBRE
            {id:1006,type:"Comida",name:"Pollo con Almendras y Zanahoria",kcal:550,p:45,c:20,f:30,ings:"Pollo (200g), Almendras (50g), Zanahoria (100g), Pan (40g)"},
            {id:1007,type:"Comida",name:"Ensalada Pasta Ma√≠z y Langostinos",kcal:420,p:30,c:55,f:10,ings:"Pasta ma√≠z (40g), Langostinos (50g), Huevos (3), Verduras"},
            {id:1008,type:"Comida",name:"Patata Asada y Ternera",kcal:600,p:40,c:60,f:20,ings:"Patata asada (300g), Ternera (180g), Aguacate (1ud)"},
            {id:1009,type:"Comida",name:"Salteado Zanahoria y At√∫n",kcal:350,p:35,c:30,f:10,ings:"Zanahoria (250g), Pimiento, Champi√±ones, At√∫n (200g), Arroz (70g)"},
            {id:1010,type:"Cena",name:"Sepia plancha con Arroz",kcal:420,p:35,c:45,f:8,ings:"Sepia (200g), Arroz (60g), Verduras"},
            {id:1011,type:"Cena",name:"At√∫n horno y Boniato",kcal:350,p:30,c:35,f:10,ings:"At√∫n fresco (150g), Boniato (150g), Aceite (5g)"},

            // --- PLATOS CL√ÅSICOS (Selecci√≥n) ---
            {id:1,type:"Desayuno",name:"Desayuno Completo Pavo",kcal:781,p:30,c:120,f:20,ings:"Leche (150g), Pan (100g), Pavo (45g), Queso (45g), Pl√°tano (125g)"},
            {id:7,type:"Desayuno",name:"Bebida Avena y Tostada",kcal:530,p:20,c:80,f:15,ings:"Bebida avena (300g), Pan integral (100g), Pavo (45g), Aceite (8g)"},
            {id:21,type:"Desayuno",name:"Pan Integral con Almendras",kcal:657,p:26,c:95,f:21,ings:"Leche (225g), Bebida almendras (225g), Pan (70g), Pavo (30g)"},
            {id:40,type:"Desayuno",name:"Tortitas de Avena Claras",kcal:557,p:27,c:66,f:21,ings:"Claras (105g), Avena (30g), Miel (10g), Nueces (15g)"},
            {id:91,type:"Desayuno",name:"Porridge de avena",kcal:330,p:12,c:55,f:6,ings:"Leche desnatada (250g), Avena (50g), Canela"},
            {id:76,type:"Desayuno",name:"Bowl Avena y Yogur",kcal:693,p:27,c:84,f:28,ings:"Leche (150g), Yogur (250g), Avena (60g), Chocolate (40g)"},
            
            {id:2,type:"Tentempi√©",name:"Yogur Griego con Granada",kcal:335,p:11,c:46,f:14,ings:"Yogur griego (125g), Avellana (15g), Granada (200g)"},
            {id:8,type:"Tentempi√©",name:"Bocadillo Bonito",kcal:305,p:20,c:37,f:7,ings:"Pan (70g), Bonito (55g), Tomate (90g)"},
            {id:12,type:"Tentempi√©",name:"Bocadillo Sardinas",kcal:325,p:18,c:37,f:10,ings:"Pan (70g), Sardinas (60g), Tomate (30g)"},
            {id:33,type:"Tentempi√©",name:"Tortitas Arroz Guacamole",kcal:280,p:12,c:35,f:9,ings:"Tortitas (30g), Guacamole (30g), Jam√≥n (50g)"},
            {id:50,type:"Tentempi√©",name:"Mandarina y Avellanas",kcal:95,p:1,c:16,f:3,ings:"Mandarina (120g), Avellana (5g)"},
            
            {id:3,type:"Comida",name:"Alubias con acelgas",kcal:329,p:16,c:52,f:6,ings:"Alubias (210g), Patata (100g), Acelgas (100g)"},
            {id:4,type:"Comida",name:"Pollo asado",kcal:510,p:60,c:6,f:27,ings:"Pollo asado (300g)"},
            {id:9,type:"Comida",name:"Espaguetis con Pavo",kcal:460,p:35,c:65,f:3,ings:"Espagueti (80g), Yogur (125g), Pavo (120g)"},
            {id:10,type:"Comida",name:"Salm√≥n plancha y ma√≠z",kcal:505,p:36,c:16,f:32,ings:"Salm√≥n (170g), Zanahoria (80g), Ma√≠z (50g)"},
            {id:13,type:"Comida",name:"Lentejas con Pimiento",kcal:288,p:15,c:50,f:5,ings:"Lentejas (200g), Pimiento (150g)"},
            {id:14,type:"Comida",name:"Lomo con patatas",kcal:330,p:39,c:25,f:6,ings:"Lomo (150g), Patata (150g)"},
            {id:17,type:"Comida",name:"Arroz con Anchoas",kcal:300,p:9,c:35,f:14,ings:"Arroz (125g), Anchoas (20g), Nueces (15g)"},
            {id:22,type:"Comida",name:"Macarrones con Tomate",kcal:450,p:25,c:70,f:5,ings:"Macarrones (90g), Tomate frito (60g), At√∫n (60g)"},
            {id:25,type:"Comida",name:"Arroz con Surimi",kcal:350,p:10,c:40,f:14,ings:"Arroz (125g), Surimi (60g), Aguacate (40g)"},
            {id:29,type:"Comida",name:"Garbanzos con At√∫n",kcal:606,p:50,c:64,f:17,ings:"Garbanzos (200g), At√∫n (110g), Tomate (150g)"},
            {id:55,type:"Comida",name:"Espaguetis a la pimienta",kcal:350,p:10,c:60,f:8,ings:"Espagueti (80g), Aceite (5g), Ajo, Tomate (50g)"},
            {id:60,type:"Comida",name:"Arroz basmati con huevo",kcal:250,p:12,c:35,f:12,ings:"Huevo (55g), Arroz (60g), Pipas (10g)"},
            {id:73,type:"Comida",name:"Pollo al ajillo",kcal:502,p:25,c:22,f:30,ings:"Pollo (150g), Yogur (125g)"},
            
            {id:5,type:"Merienda",name:"Pan Centeno y Hummus",kcal:192,p:6,c:37,f:2,ings:"Pan centeno (40g), Hummus (15g), Naranja (130g)"},
            {id:6,type:"Merienda",name:"Bocadillo Pavo Tomate",kcal:129,p:7,c:21,f:1,ings:"Pan (40g), Tomate (45g), Pavo (15g)"},
            {id:19,type:"Merienda",name:"Bocadillo Salm√≥n",kcal:322,p:15,c:40,f:8,ings:"Pan (70g), Salm√≥n ahumado (30g), Tomate (90g)"},
            {id:31,type:"Merienda",name:"Pl√°tano",kcal:178,p:2,c:46,f:0,ings:"Pl√°tano (200g)"},
            {id:52,type:"Merienda",name:"Pan Wasa y At√∫n",kcal:294,p:24,c:33,f:6,ings:"Pan Wasa (40g), At√∫n (56g), Guisantes (145g)"},
            {id:99,type:"Merienda",name:"Batido de prote√≠nas",kcal:150,p:25,c:5,f:2,ings:"Prote√≠na (30g), Agua"},
            {id:109,type:"Merienda",name:"Queso batido y nueces",kcal:180,p:12,c:8,f:10,ings:"Queso batido (150g), Nueces (10g)"},
            
            {id:7,type:"Cena",name:"Tortilla espinacas",kcal:166,p:13,c:2,f:11,ings:"Claras (35g), Huevo (60g), Espinaca (50g)"},
            {id:11,type:"Cena",name:"At√∫n plancha berenjena",kcal:276,p:43,c:9,f:6,ings:"At√∫n (150g), Berenjena (150g)"},
            {id:16,type:"Cena",name:"Lenguado con Br√≥coli",kcal:329,p:52,c:8,f:10,ings:"Lenguado (270g), Br√≥coli (125g)"},
            {id:28,type:"Cena",name:"Caballa con Can√≥nigos",kcal:383,p:30,c:6,f:26,ings:"Caballa (150g), Can√≥nigos (30g), Ma√≠z (30g)"},
            {id:32,type:"Cena",name:"Huevos con Jam√≥n",kcal:658,p:49,c:35,f:35,ings:"Huevo (120g), Jam√≥n (90g), Pan (70g)"},
            {id:36,type:"Cena",name:"Trucha con Acelgas",kcal:317,p:9,c:43,f:12,ings:"Trucha (450g), Acelgas (150g), Pan (70g)"},
            {id:63,type:"Cena",name:"Tortilla de calabac√≠n",kcal:257,p:20,c:5,f:16,ings:"Huevo (60g), Calabac√≠n (125g), Claras (105g)"},
            {id:82,type:"Cena",name:"Lenguado y br√≥coli",kcal:436,p:67,c:10,f:15,ings:"Lenguado (350g), Br√≥coli (150g)"},
            {id:104,type:"Cena",name:"Crema calabac√≠n y pavo",kcal:280,p:20,c:20,f:10,ings:"Calabac√≠n (200g), Patata (50g), Pavo (100g)"}
        ];

        // --- ESTADO ---
        let activeDay = "Lunes";
        let activeCat = "Desayuno";
        let targets = {};
        let weeklyPlan = { "Lunes":[], "Martes":[], "Mi√©rcoles":[], "Jueves":[], "Viernes":[], "S√°bado":[], "Domingo":[] };
        const days = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];

        // --- INICIO ---
        window.onload = function() {
            // Cargar datos
            const t = localStorage.getItem('maldofit_targets');
            const p = localStorage.getItem('maldofit_plan');
            
            if(t) targets = JSON.parse(t);
            else calculateMacros(); // Calcular default si no hay datos

            if(p) weeklyPlan = JSON.parse(p);

            renderLib();
            renderPlan();
        };

        // --- CALCULADORA AVANZADA ---
        function calculateMacros() {
            const w = parseFloat(document.getElementById('w').value);
            const h = parseFloat(document.getElementById('h').value);
            const a = parseFloat(document.getElementById('a').value);
            const s = document.getElementById('s').value;
            const act = parseFloat(document.getElementById('act').value);
            const goal = parseFloat(document.getElementById('goal').value);

            // Harris-Benedict Revisada
            let bmr;
            if(s === 'm') bmr = 88.362 + (13.397 * w) + (4.799 * h) - (5.677 * a);
            else bmr = 447.593 + (9.247 * w) + (3.098 * h) - (4.330 * a);

            const tdee = Math.round(bmr * act);
            const targetKcal = Math.round(tdee * (1 + goal));

            // Reparto Macros Personalizado (CrossFit Base)
            // Prot: 2g/kg (Definici√≥n sube a 2.2-2.5, Volumen baja a 1.8-2.0, pero dejamos 2.0 est√°ndar seguro)
            const p = Math.round(w * 2.0); 
            // Grasa: 0.9 - 1g/kg
            const f = Math.round(w * 0.9);
            // Carbos: El resto
            const c = Math.round((targetKcal - (p * 4) - (f * 9)) / 4);

            // Guardar para todos los d√≠as
            days.forEach(d => {
                targets[d] = { k: targetKcal, p: p, c: c, f: f };
            });

            // Actualizar tabla visual
            const tbody = document.getElementById('cycle-body');
            tbody.innerHTML = '';
            days.forEach(d => {
                tbody.innerHTML += `<tr><td>${d}</td><td>${targetKcal}</td><td>${p}</td><td>${c}</td><td>${f}</td></tr>`;
            });

            // Guardar
            localStorage.setItem('maldofit_targets', JSON.stringify(targets));
            renderPlan(); // Actualizar barras
        }

        // --- UI FUNCIONES ---
        function setDay(d, el) {
            activeDay = d;
            document.querySelectorAll('.day-pill').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            renderPlan();
        }

        function filterCat(c, el) {
            activeCat = c;
            document.querySelectorAll('.cat-chip').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            renderLib();
        }

        function switchView(vid, el) {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.getElementById(vid).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
        }

        function renderLib() {
            const list = document.getElementById('lib-list');
            const term = document.getElementById('search').value.toLowerCase();
            list.innerHTML = '';

            const filtered = foodDB.filter(x => {
                let matchCat = x.type === activeCat;
                // Mapeo flexible para las categor√≠as de los PDFs nuevos
                if (activeCat === 'Tentempi√©' && (x.type === 'M.MA√ëANA' || x.type === 'Media Ma√±ana')) matchCat = true;
                
                return matchCat && (x.name.toLowerCase().includes(term) || x.ings.toLowerCase().includes(term));
            });

            filtered.forEach(x => {
                const div = document.createElement('div');
                div.className = 'meal-item';
                div.innerHTML = `
                    <div class="meal-type">${x.type}</div>
                    <div class="meal-name">${x.name}</div>
                    <div class="meal-info">üî• ${x.kcal} ¬∑ P:${x.p} ¬∑ C:${x.c} ¬∑ G:${x.f}</div>
                    <div class="ing-text">${x.ings}</div>
                    <button class="add-btn" onclick="addFood(${x.id})">+</button>
                `;
                list.appendChild(div);
            });
        }

        function addFood(id) {
            const item = foodDB.find(x => x.id === id);
            weeklyPlan[activeDay].push(item);
            savePlan();
            renderPlan();
        }

        function removeFood(idx) {
            weeklyPlan[activeDay].splice(idx, 1);
            savePlan();
            renderPlan();
        }

        function savePlan() {
            localStorage.setItem('maldofit_plan', JSON.stringify(weeklyPlan));
        }

        function renderPlan() {
            const list = document.getElementById('planner-list');
            list.innerHTML = '';
            
            let tots = {k:0, p:0, c:0, f:0};
            
            weeklyPlan[activeDay].forEach((x, i) => {
                tots.k += x.kcal; tots.p += x.p; tots.c += x.c; tots.f += x.f;
                const div = document.createElement('div');
                div.className = 'meal-item';
                div.innerHTML = `
                    <div class="meal-type">${x.type}</div>
                    <div class="meal-name">${x.name}</div>
                    <div class="meal-info">üî• ${x.kcal} ¬∑ P:${x.p} ¬∑ C:${x.c} ¬∑ G:${x.f}</div>
                    <button class="btn-del" onclick="removeFood(${i})">&times;</button>
                `;
                list.appendChild(div);
            });

            // Update Stats
            const tgt = targets[activeDay] || {k:2500, p:160, c:300, f:70};
            
            document.getElementById('val-k').innerText = `${tots.k} / ${tgt.k}`;
            document.getElementById('bar-k').style.width = Math.min((tots.k/tgt.k)*100, 100) + '%';
            
            document.getElementById('val-p').innerText = `${tots.p} / ${tgt.p}g`;
            document.getElementById('bar-p').style.width = Math.min((tots.p/tgt.p)*100, 100) + '%';
            
            document.getElementById('val-c').innerText = `${tots.c} / ${tgt.c}g`;
            document.getElementById('bar-c').style.width = Math.min((tots.c/tgt.c)*100, 100) + '%';
            
            document.getElementById('val-f').innerText = `${tots.f} / ${tgt.f}g`;
            document.getElementById('bar-f').style.width = Math.min((tots.f/tgt.f)*100, 100) + '%';
        }
    </script>
</body>
</html>
